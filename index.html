<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown åœ¨çº¿ç¼–è¾‘å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        .toolbar {
            background: #2d2d2d;
            color: #fff;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 100;
            transition: height 0.3s ease;
        }
        .toolbar.hidden { height: 0; padding: 0; overflow: hidden; }
        .toolbar h1 {
            font-size: 18px;
            margin-right: 20px;
            font-weight: 500;
        }
        .toolbar-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .toolbar-btn {
            background: #3d3d3d;
            border: 1px solid #4d4d4d;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 3px;
            min-width: auto;
            white-space: nowrap;
        }
        .toolbar-btn:hover { background: #4d4d4d; }
        .toolbar-divider { width: 1px; height: 24px; background: #4d4d4d; margin: 0 10px; }
        .syntax-link {
            color: #aaa;
            text-decoration: none;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .syntax-link:hover { color: #fff; text-decoration: underline; }
        .main-content { display: flex; height: calc(100vh - 50px); }
        .editor-container {
            flex: 1;
            display: flex;
            height: 100%;
        }
        .splitter {
            width: 6px;
            background: #e8e8e8;
            cursor: col-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .splitter:hover { background: #d0d0d0; }
        .editor {
            flex: 1;
            padding: 20px;
            background: #fafafa;
            color: #333;
            font-size: 15px;
            line-height: 1.6;
            border: none;
            resize: none;
            outline: none;
            font-family: 'Consolas', 'Monaco', monospace;
            overflow-y: auto;
        }
        .preview { width: 0; overflow-y: auto; transition: width 0.3s ease; }
        .preview.show { width: 50%; }
        .preview { line-height: 1.8; color: #333; }
        .preview h1 { font-size: 2em; margin: 0.67em 0 0.5em; border-bottom: 2px solid #eee; padding-bottom: 0.3em; }
        .preview h2 { font-size: 1.5em; margin: 0.75em 0 0.5em; border-bottom: 1px solid #eee; padding-bottom: 0.2em; }
        .preview h3 { font-size: 1.25em; margin: 0.83em 0 0.5em; }
        .preview h4 { font-size: 1em; margin: 1em 0 0.5em; }
        .preview p { margin: 1em 0; }
        .preview code { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9em; }
        .preview pre { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 8px; overflow-x: auto; margin: 1em 0; }
        .preview pre code { background: transparent; padding: 0; font-size: 14px; }
        .preview blockquote { border-left: 4px solid #007bff; margin: 1em 0; padding-left: 1em; color: #666; background: #f8f9fa; border-radius: 0 4px 4px 0; }
        .preview ul, .preview ol { margin: 1em 0; padding-left: 2em; }
        .preview li { margin: 0.4em 0; }
        .preview a { color: #007bff; text-decoration: none; }
        .preview a:hover { text-decoration: underline; }
        .preview img { max-width: 100%; height: auto; }
        .preview table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        .preview th, .preview td { border: 1px solid #ddd; padding: 8px 12px; }
        .preview th { background: #f5f5f5; }
        .preview hr { border: none; border-top: 1px solid #ddd; margin: 2em 0; }
        .preview .mermaid { background: #fafafa; padding: 20px; border-radius: 8px; display: flex; justify-content: center; align-items: center; }
        .preview .mermaid svg { max-width: 100%; max-height: 600px; }
        .shortcut-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .shortcut-modal.show { display: flex; }
        .shortcut-content {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .shortcut-content h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .shortcut-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .shortcut-item { display: flex; align-items: center; gap: 10px; }
        .shortcut-key {
            background: #f0f0f0;
            border: 1px solid #d0d0d0;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            min-width: 80px;
            text-align: center;
        }
        .shortcut-desc { color: #666; font-size: 14px; }
        .shortcut-close {
            margin-top: 20px;
            padding: 10px 30px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .shortcut-close:hover { background: #0069d9; }

        /* æ‚¬æµ®èœå•æŒ‰é’® */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            background: #2d2d2d;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        .fab.show { transform: rotate(45deg); }

        /* æ‚¬æµ®èœå• */
        .fab-menu {
            position: fixed;
            bottom: 95px;
            right: 30px;
            background: #2d2d2d;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            z-index: 998;
            display: none;
            flex-direction: column;
            gap: 5px;
            min-width: 160px;
        }
        .fab-menu.show { display: flex; }
        .fab-menu.exported { flex-direction: column; gap: 5px; }
        .export-submenu-btn { width: 100%; }
        .fab-menu-btn {
            background: transparent;
            border: none;
            color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }
        .fab-menu-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        .fab-menu-btn.active {
            background: rgba(0, 123, 255, 0.3);
        }
        @media (max-width: 768px) {
            .toolbar { padding: 6px 10px; }
            .toolbar h1 { font-size: 14px; margin-right: 10px; white-space: nowrap; }
            .toolbar-buttons { gap: 2px; }
            .toolbar-btn { padding: 4px 8px; font-size: 11px; }
            .editor, .preview { font-size: 14px; padding: 10px; }
            .preview.show { width: 100%; }
            .syntax-link span { display: none; }
        }
    </style>
</head>
<body>
    <div class="toolbar" id="toolbar">
        <h1>ğŸ“ Markdown ç¼–è¾‘å™¨</h1>
        <div class="toolbar-buttons">
            <button class="toolbar-btn primary" onclick="insertBold()">**åŠ ç²—**</button>
            <button class="toolbar-btn" onclick="insertItalic()">*æ–œä½“*</button>
            <button class="toolbar-btn" onclick="insertHeading()"><h1>H1</h1></button>
            <button class="toolbar-btn" onclick="insertHeading('##')"><h2>H2</h2></button>
            <button class="toolbar-btn" onclick="insertHeading('###')"><h3>H3</h3></button>
            <button class="toolbar-btn" onclick="insertQuote()">Â» å¼•ç”¨</button>
            <button class="toolbar-btn" onclick="insertCodeBlock()">` ä»£ç   </button>
            <button class="toolbar-btn" onclick="insertCodeBlock('```javascript')">JS ä»£ç å—</button>
            <button class="toolbar-btn" onclick="insertCodeBlock('```python')">Py ä»£ç å—</button>
            <button class="toolbar-btn" onclick="insertCodeBlock('```html')">HTML ä»£ç å—</button>
            <button class="toolbar-btn" onclick="insertUnorderedList()">â€¢ åˆ—è¡¨</button>
            <button class="toolbar-btn" onclick="insertOrderedList()">1. ç¼–å·åˆ—è¡¨</button>
            <button class="toolbar-btn" onclick="insertLink()">ğŸ”— é“¾æ¥</button>
            <button class="toolbar-btn" onclick="insertImage()">ğŸ–¼ï¸ å›¾ç‰‡</button>
            <button class="toolbar-btn" onclick="insertHorizontalRule()">â€” åˆ†éš”çº¿</button>
            <button class="toolbar-btn" onclick="insertMermaid('flowchart')">ğŸ”€ æµç¨‹å›¾</button>
            <button class="toolbar-btn" onclick="insertMermaid('sequence')">â†”ï¸ åºåˆ—å›¾</button>
            <button class="toolbar-btn" onclick="insertMermaid('class')">ğŸ“¦ ç±»å›¾</button>
            <button class="toolbar-btn" onclick="insertMermaid('state')">â–¶ï¸ çŠ¶æ€å›¾</button>
        </div>
        <div class="toolbar-divider"></div>
        <div class="toolbar-buttons">
            <button class="toolbar-btn" id="togglePreview" onclick="togglePreview()" title="æ˜¾ç¤º/éšè—é¢„è§ˆ">ğŸ‘ï¸ é¢„è§ˆ</button>
            <select id="splitRatio" onchange="changeSplitRatio()" title="è°ƒæ•´åˆ†å‰²æ¯”ä¾‹">
                <option value="33">33%</option>
                <option value="50" selected>50%</option>
                <option value="66">66%</option>
            </select>
            <button class="toolbar-btn" onclick="clearEditor()" title="æ¸…ç©ºç¼–è¾‘å™¨">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        <a href="#" class="syntax-link" onclick="showShortcuts(event)">
            âŒ¨ï¸ å¿«æ·é”® <span>â†’</span>
        </a>
    </div>
    <div class="main-content">
        <div class="editor-container" id="editorContainer">
            <textarea class="editor" id="markdownInput" placeholder="åœ¨æ­¤å¼€å§‹ç¼–å†™ Markdown..." oninput="updatePreview()"></textarea>
            <div class="splitter" id="splitter" onmousedown="startResize(event)"></div>
            <div class="preview" id="preview"></div>
        </div>
    </div>
    <div class="shortcut-modal" id="shortcutModal">
        <div class="shortcut-content">
            <h2>âŒ¨ï¸ å¿«æ·é”®åˆ—è¡¨</h2>
            <div class="shortcut-grid">
                <div class="shortcut-item"><span class="shortcut-key">Ctrl/Cmd</span> <span class="shortcut-desc">+ B</span> <span class="shortcut-desc">åŠ ç²—</span></div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl/Cmd</span> <span class="shortcut-desc">+ I</span> <span class="shortcut-desc">æ–œä½“</span></div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl/Cmd</span> <span class="shortcut-desc">+ K</span> <span class="shortcut-desc">é“¾æ¥</span></div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl/Cmd</span> <span class="shortcut-desc">+ E</span> <span class="shortcut-desc">ä»£ç </span></div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl/Cmd</span> <span class="shortcut-desc">+ L</span> <span class="shortcut-desc">åˆ—è¡¨</span></div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl/Cmd</span> <span class="shortcut-desc">+ M</span> <span class="shortcut-desc">æµç¨‹å›¾</span></div>
            </div>
            <button class="shortcut-close" onclick="closeShortcuts()">å…³é—­</button>
        </div>
    </div>
    <button class="fab" id="fab" onclick="toggleFabMenu()" title="åŠŸèƒ½èœå•">+</button>
    <div class="fab-menu" id="fabMenu">
        <button class="fab-menu-btn active" id="menuToggleToolbar" onclick="toggleToolbar()">
            âš™ï¸ éšè—å·¥å…·æ 
        </button>
        <button class="fab-menu-btn" onclick="window.open('https://mermaid.js.org/syntax/flowchart.html', '_blank'); toggleFabMenu();">
            ğŸ“Š Mermaid ç”»å›¾è¯­æ³•
        </button>
        <button class="fab-menu-btn" onclick="window.open('https://markdown.com.cn/basic-syntax/', '_blank'); toggleFabMenu();">
            ğŸ“– Markdown è¯­æ³•å‚è€ƒ
        </button>
        <button class="fab-menu-btn" id="fabPreviewBtn" onclick="togglePreview(); updateFabPreviewBtnText(); toggleFabMenu();">
            ğŸ‘ï¸ é¢„è§ˆ
        </button>
        <button class="fab-menu-btn" onclick="exportMD(); toggleFabMenu();">
            ğŸ“„ å¯¼å‡º MD
        </button>
        <button class="fab-menu-btn" onclick="exportPDF(); toggleFabMenu();">
            ğŸ“‘ å¯¼å‡º PDF
        </button>
        <button class="fab-menu-btn" onclick="clearEditor(); toggleFabMenu();">
            ğŸ—‘ï¸ æ¸…ç©ºç¼–è¾‘å™¨
        </button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg2pdf@0.5.1/dist/svg2pdf.umd.min.js"></script>
    <script>
        console.log('=== Markdown ç¼–è¾‘å™¨å¯åŠ¨ ===');

        const editor = document.getElementById('markdownInput');
        const preview = document.getElementById('preview');
        const editorContainer = document.getElementById('editorContainer');
        const splitter = document.getElementById('splitter');
        const toolbar = document.getElementById('toolbar');
        const fab = document.getElementById('fab');
        const fabMenu = document.getElementById('fabMenu');
        const menuToggleToolbar = document.getElementById('menuToggleToolbar');
        let isResizing = false;

        console.log('DOM å…ƒç´ è·å–å®Œæˆ');

        let mermaidInitialized = false;
        async function initMermaid() {
            if (mermaidInitialized) return;
            console.log('åˆå§‹åŒ– Mermaid...');

            try {
                if (typeof mermaid === 'undefined') {
                    throw new Error('Mermaid åº“æœªåŠ è½½');
                }
                await mermaid.initialize({ startOnLoad: false, theme: 'default' });
                mermaidInitialized = true;
                console.log('Mermaid åˆå§‹åŒ–å®Œæˆ');
            } catch (e) {
                console.error('Mermaid åˆå§‹åŒ–å¤±è´¥:', e);
            }
        }

        async function updatePreview() {
            console.log('å¼€å§‹æ›´æ–°é¢„è§ˆ...');
            await initMermaid();

            const markdown = editor.value;
            console.log('ç¼–è¾‘å™¨å†…å®¹:', markdown.substring(0, 200));

            const parsed = marked.parse(markdown);
            const parsedWithMermaid = parsed.replace(/<pre><code class="language-mermaid">([\s\S]*?)<\/code><\/pre>/g, '<div class="mermaid">$1</div>');
            console.log('å¤„ç†åçš„å†…å®¹:', parsedWithMermaid.substring(0, 200));

            preview.innerHTML = parsedWithMermaid;

            const mermaidElements = preview.querySelectorAll('.mermaid');
            console.log('æ‰¾åˆ°', mermaidElements.length, 'ä¸ª Mermaid å…ƒç´ ');

            if (mermaidElements.length > 0) {
                const elements = Array.from(mermaidElements).map((el, i) => {
                    el.id = 'mermaid-' + i;
                    return el;
                });

                setTimeout(async () => {
                    try {
                        await mermaid.run({ nodes: elements });
                        console.log('Mermaid æ¸²æŸ“æˆåŠŸ');
                    } catch (e) {
                        console.error('Mermaid æ¸²æŸ“é”™è¯¯:', e);
                        elements.forEach(el => {
                            el.innerHTML = `<span style="color:red">âŒ æ¸²æŸ“é”™è¯¯</span>`;
                        });
                    }
                }, 50);
            }
        }

        function insertTextAtCursor(text, preserveCursor = true) {
            const startPos = editor.selectionStart;
            const endPos = editor.selectionEnd;
            const textBefore = editor.value.substring(0, startPos);
            const textAfter = editor.value.substring(endPos);
            const selectedText = editor.value.substring(startPos, endPos);

            editor.value = textBefore + text + selectedText + textAfter;

            if (preserveCursor && selectedText) {
                editor.focus();
                editor.setSelectionRange(startPos + text.length, startPos + text.length);
            } else {
                editor.focus();
            }
            updatePreview();
        }

        function insertBold() { insertTextAtCursor('**', '**'); }
        function insertItalic() { insertTextAtCursor('*', '*'); }
        function insertHeading(level = '##') { insertTextAtCursor(`\n${level} æ ‡é¢˜\n\n`, false); }
        function insertQuote() { insertTextAtCursor('\n> å¼•ç”¨æ–‡æœ¬\n\n', false); }
        function insertCodeBlock(lang = '```') { insertTextAtCursor(`\n${lang}\nä»£ç \n\`\`\`\n\n`, false); }
        function insertUnorderedList() { insertTextAtCursor('\n- é¡¹ç›® 1\n- é¡¹ç›® 2\n\n', false); }
        function insertOrderedList() { insertTextAtCursor('\n1. ç¬¬ä¸€ä¸ª\n2. ç¬¬äºŒä¸ª\n\n', false); }
        function insertLink() {
            const url = prompt('é“¾æ¥åœ°å€:', 'https://');
            const text = prompt('æ˜¾ç¤ºæ–‡æœ¬:', 'é“¾æ¥');
            if (url && text) insertTextAtCursor(`[${text}](${url})`, false);
        }
        function insertImage() {
            const url = prompt('å›¾ç‰‡åœ°å€:', 'https://');
            const alt = prompt('æ›¿ä»£æ–‡æœ¬:', 'å›¾ç‰‡');
            if (url && alt) insertTextAtCursor(`![${alt}](${url})`, false);
        }
        function insertHorizontalRule() { insertTextAtCursor('\n---\n\n', false); }
        function insertMermaid(type = 'flowchart') {
            const templates = {
                flowchart: `graph TD\n    A[å¼€å§‹] --> B[å¤„ç†]\n    B --> C{åˆ¤æ–­}\n    C -- æ˜¯ --> D[æˆåŠŸ]\n    C -- å¦ --> E[å¤±è´¥]\n    D --> F[ç»“æŸ]\n    E --> B`,
                sequence: `sequenceDiagram\n    A->>B: è¯·æ±‚\n    B->>C: å¤„ç†\n    C-->>B: å“åº”\n    B-->>A: è¿”å›`,
                class: `classDiagram\nclass User {\n    +String name\n    +login()\n}\nclass System {\n    +process()\n}`,
                state: `stateDiagram-v2\n    [*] --> å¼€å§‹\n    å¼€å§‹ --> ç»“æŸ`
            };
            insertTextAtCursor(`\n\`\`\`mermaid\n${templates[type]}\n\`\`\`\n\n`, false);
        }

        function toggleToolbar() {
            toolbar.classList.toggle('hidden');
            const isHidden = toolbar.classList.contains('hidden');
            menuToggleToolbar.textContent = isHidden ? 'âš™ï¸ æ˜¾ç¤ºå·¥å…·æ ' : 'âš™ï¸ éšè—å·¥å…·æ ';
            menuToggleToolbar.classList.toggle('active', !isHidden);
        }

        // åˆå§‹åŒ–èœå•çŠ¶æ€
        menuToggleToolbar.textContent = 'âš™ï¸ éšè—å·¥å…·æ ';
        menuToggleToolbar.classList.add('active');

        function toggleFabMenu() {
            console.log('toggleFabMenu called');
            fab.classList.toggle('show');
            fabMenu.classList.toggle('show');
            fabMenu.classList.remove('exported');
            console.log('fabMenu.classList:', fabMenu.classList.toString());
        }

        function generateFileName(ext) {
            const now = new Date();
            const timestamp = now.getTime();
            const random = Math.floor(Math.random() * 1000);
            const dateStr = now.toISOString().slice(0, 10);
            return `markdown_${dateStr}_${timestamp}_${random}.${ext}`;
        }

        function exportMD() {
            const content = editor.value;
            const filename = generateFileName('md');
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function exportPDF() {
            if (!window.jspdf || !window.html2canvas) {
                alert('PDFå¯¼å‡ºåº“åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•');
                return;
            }

            const { jsPDF } = window.jspdf;

            // æ˜¾ç¤º loading æç¤º
            showLoading('æ­£åœ¨å¯¼å‡º PDF...');

            // éšè—åˆ†å‰²çº¿ï¼Œåªæ˜¾ç¤ºé¢„è§ˆå†…å®¹
            preview.style.width = '100%';
            preview.style.borderLeft = 'none';
            preview.style.paddingLeft = '0';

            // ç­‰å¾…æ‰€æœ‰ Mermaid å›¾è¡¨æ¸²æŸ“å®Œæˆ
            const mermaidElements = preview.querySelectorAll('.mermaid');
            console.log('Mermaid elements count:', mermaidElements.length);

            if (mermaidElements.length > 0) {
                try {
                    if (window.mermaid) {
                        console.log('Mermaid render started');
                        await mermaid.run({
                            nodes: Array.from(mermaidElements)
                        });
                        console.log('Mermaid render completed');
                        // ç­‰å¾… SVG æ¸²æŸ“å®Œæˆ
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                } catch (e) {
                    console.log('Mermaid æ¸²æŸ“:', e);
                }
            }

            // ç­‰å¾… html2canvas æ¸²æŸ“
            await new Promise(resolve => setTimeout(resolve, 100));

            try {
                // åˆ›å»ºä¸€ä¸ªå…‹éš†çš„é¢„è§ˆå®¹å™¨ç”¨äºå¯¼å‡ºï¼ˆä¸å½±å“åŸé¢„è§ˆï¼‰
                const exportContainer = document.createElement('div');
                exportContainer.style.cssText = `
                    position: absolute;
                    left: -9999px;
                    top: 0;
                    width: 100%;
                    overflow: hidden;
                    background: white;
                `;
                exportContainer.innerHTML = preview.innerHTML;

                // éšè—åˆ†å‰²çº¿æ ·å¼
                exportContainer.style.borderLeft = 'none';
                exportContainer.style.paddingLeft = '0';

                // ç¡®ä¿ Mermaid å›¾è¡¨å±…ä¸­
                const mermaidElements = exportContainer.querySelectorAll('.mermaid');
                mermaidElements.forEach(el => {
                    el.style.display = 'flex';
                    el.style.justifyContent = 'center';
                    el.style.alignItems = 'center';
                    el.style.margin = '20px 0';
                });

                document.body.appendChild(exportContainer);

                // ä½¿ç”¨ html2canvas æ•è·å¯¼å‡ºå®¹å™¨
                const canvas = await html2canvas(exportContainer, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    foreignObjectRendering: false,
                    backgroundColor: '#ffffff'
                });

                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageHeight = 297; // A4 height in mm
                const pdfWidth = 210; // A4 width in mm

                console.log('Canvas size:', canvasWidth, 'x', canvasHeight);

                // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                const scale = pdfWidth / canvasWidth;
                const scaledHeight = canvasHeight * scale;

                // è®¡ç®—é¡µæ•°
                const pages = Math.ceil(scaledHeight / pageHeight);

                const margin = 20; // å·¦å³è¾¹è·ï¼ˆmmï¼‰
                const topMargin = 10; // é¡¶éƒ¨è¾¹è·ï¼ˆmmï¼‰

                for (let i = 0; i < pages; i++) {
                    if (i > 0) {
                        pdf.addPage();
                    }

                    const y = -i * pageHeight + topMargin;
                    const height = Math.min(pageHeight - topMargin - margin, scaledHeight - i * pageHeight);

                    pdf.addImage(canvas.toDataURL(), 'PNG', margin, y, pdfWidth - margin * 2, height);
                }

                document.body.removeChild(exportContainer);

                const filename = generateFileName('pdf');
                pdf.save(filename);

                // éšè— loading æç¤º
                hideLoading();
            } catch (error) {
                console.error('PDFå¯¼å‡ºå¤±è´¥:', error);
                hideLoading();
                alert('PDFå¯¼å‡ºå¤±è´¥: ' + error.message);
            }

            // æ¢å¤åŸæ¥çš„å®½åº¦
            setTimeout(() => {
                const currentWidth = editor.style.width || '50%';
                preview.style.width = currentWidth;
                preview.style.borderLeft = '';
                preview.style.paddingLeft = '';
            }, 100);
        }

        function togglePreview() {
            if (preview.classList.contains('show')) {
                preview.classList.remove('show');
                preview.style.width = '';
            } else {
                preview.classList.add('show');
                preview.style.width = '';
            }
            updateFabPreviewBtnText();
            updatePreviewBtnText();
        }

        function updatePreviewBtnText() {
            const btn = document.getElementById('togglePreview');
            if (btn) {
                btn.textContent = preview.classList.contains('show') ? 'ğŸ‘ï¸ éšè—' : 'ğŸ‘ï¸ é¢„è§ˆ';
            }
        }

        function updateFabPreviewBtnText() {
            const btn = document.getElementById('fabPreviewBtn');
            if (btn) {
                btn.textContent = preview.classList.contains('show') ? 'ğŸ‘ï¸ éšè—' : 'ğŸ‘ï¸ é¢„è§ˆ';
            }
        }

        function changeSplitRatio() {
            const ratio = document.getElementById('splitRatio').value;
            editor.style.width = ratio + '%';
            preview.style.width = (100 - ratio) + '%';
            preview.classList.add('show');
        }

        let loadingElement = null;
        function showLoading(message) {
            if (loadingElement) return;
            loadingElement = document.createElement('div');
            loadingElement.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 20px 40px;
                border-radius: 8px;
                z-index: 10000;
                font-size: 16px;
            `;
            loadingElement.textContent = message;
            document.body.appendChild(loadingElement);
        }

        function hideLoading() {
            if (loadingElement) {
                loadingElement.remove();
                loadingElement = null;
            }
        }

        function clearEditor() {
            if (confirm('ç¡®å®šæ¸…ç©ºå—ï¼Ÿ')) {
                editor.value = '';
                updatePreview();
                updatePreviewBtnText();
                updateFabPreviewBtnText();
            }
        }

        function showShortcuts(e) {
            e.preventDefault();
            document.getElementById('shortcutModal').classList.add('show');
        }

        function closeShortcuts() {
            document.getElementById('shortcutModal').classList.remove('show');
        }

        editor.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                insertTextAtCursor('    ', true);
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                insertBold();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                e.preventDefault();
                insertItalic();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
                e.preventDefault();
                insertMermaid('flowchart');
            }
            if (e.key === '/' && document.activeElement === editor) {
                e.preventDefault();
                editor.setSelectionRange(0, 0);
                editor.focus();
            }
        });

        function startResize(e) {
            isResizing = true;
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
            e.preventDefault();
        }

        function resize(e) {
            if (!isResizing) return;
            const percentage = (e.clientX / editorContainer.getBoundingClientRect().width) * 100;
            if (percentage > 10 && percentage < 90) {
                editor.style.width = percentage + '%';
                preview.style.width = (100 - percentage) + '%';
                console.log('è°ƒæ•´å®½åº¦:', percentage + '%', 'é¢„è§ˆæ˜¾ç¤º:', preview.classList.contains('show'));
                // åªè°ƒæ•´å®½åº¦ï¼Œä¸å¼ºåˆ¶æ˜¾ç¤ºé¢„è§ˆ
            }
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }

        document.getElementById('shortcutModal').addEventListener('click', function(e) {
            if (e.target === this) closeShortcuts();
        });

        fabMenu.addEventListener('click', function(e) {
            if (e.target === fabMenu) toggleFabMenu();
        });

        splitter.addEventListener('dblclick', function() {
            editor.style.width = '50%';
            preview.style.width = '50%';
        });

        editor.value = `# æ¬¢è¿ä½¿ç”¨ Markdown ç¼–è¾‘å™¨

## å¿«é€Ÿå¼€å§‹

ç‚¹å‡»å·¥å…·æ æŒ‰é’®æˆ–ä½¿ç”¨å¿«æ·é”®å¿«é€Ÿç¼–å†™ Markdownã€‚

### æ–‡æœ¬æ ¼å¼

**ç²—ä½“** - ç‚¹å‡»å·¥å…·æ çš„ **åŠ ç²—** æŒ‰é’®æˆ–æŒ‰ Ctrl/Cmd + B
*æ–œä½“* - ç‚¹å‡»å·¥å…·æ çš„ *æ–œä½“* æŒ‰é’®æˆ–æŒ‰ Ctrl/Cmd + I
~~åˆ é™¤çº¿~~ - è‡ªå®šä¹‰ Markdown

### æ ‡é¢˜

H1 - ç‚¹å‡»å·¥å…·æ çš„ H1 æŒ‰é’®
## H2 - ç‚¹å‡»å·¥å…·æ çš„ H2 æŒ‰é’®
### H3 - ç‚¹å‡»å·¥å…·æ çš„ H3 æŒ‰é’®

### å¼•ç”¨

Â» å¼•ç”¨æ–‡æœ¬ - ç‚¹å‡»å·¥å…·æ çš„å¼•ç”¨æŒ‰é’®

### ä»£ç 

\`è¡Œå†…ä»£ç \` - ç‚¹å‡»ä»£ç æŒ‰é’®æ’å…¥
\`\`\`
ä»£ç å—
å¤šè¡Œä»£ç 
\`\`\`

### åˆ—è¡¨

- é¡¹ç›® 1 - ç‚¹å‡»åˆ—è¡¨æŒ‰é’®
  - åµŒå¥—é¡¹ç›®
- é¡¹ç›® 2
1. ç¼–å·åˆ—è¡¨ - ç‚¹å‡»ç¼–å·åˆ—è¡¨æŒ‰é’®
2. ç¬¬äºŒé¡¹

### é“¾æ¥å’Œå›¾ç‰‡

[é“¾æ¥æ–‡æœ¬](https://example.com) - ç‚¹å‡»é“¾æ¥æŒ‰é’®
![å›¾ç‰‡è¯´æ˜](https://example.com/image.jpg) - ç‚¹å‡»å›¾ç‰‡æŒ‰é’®

### åˆ†éš”çº¿

---

### Mermaid å›¾è¡¨

ğŸ”€ æµç¨‹å›¾ - ç‚¹å‡»æµç¨‹å›¾æŒ‰é’®
\`\`\`mermaid
graph TD
    A[å¼€å§‹] --> B[å¤„ç†]
    B --> C{åˆ¤æ–­}
    C -- æ˜¯ --> D[æˆåŠŸ]
    C -- å¦ --> E[å¤±è´¥]
    D --> F[ç»“æŸ]
    E --> B
\`\`\`

â†”ï¸ åºåˆ—å›¾ - ç‚¹å‡»åºåˆ—å›¾æŒ‰é’®
\`\`\`mermaid
sequenceDiagram
    A->>B: è¯·æ±‚
    B->>C: å¤„ç†
    C-->>B: å“åº”
    B-->>A: è¿”å›
\`\`\`

ğŸ“¦ ç±»å›¾ - ç‚¹å‡»ç±»å›¾æŒ‰é’®
\`\`\`mermaid
classDiagram
    class User {
        +String name
        +login()
    }
    class System {
        +process()
    }
    User --> System
\`\`\`

â–¶ï¸ çŠ¶æ€å›¾ - ç‚¹å‡»çŠ¶æ€å›¾æŒ‰é’®
\`\`\`mermaid
stateDiagram-v2
    [*] --> å¼€å§‹
    å¼€å§‹ --> ç»“æŸ
    å¼€å§‹ --> ä¸­é—´
    ä¸­é—´ --> ç»“æŸ
\`\`\`
`;
        updatePreview();
    </script>
</body>
</html>
